<!DOCTYPE html>
<html lang="tr">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>MorAI</title>

Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#f6f7fb;
Â  Â  Â  --panel:#ffffff;
Â  Â  Â  --panel2:#f9fafb;
Â  Â  Â  --border:#e5e7eb;
Â  Â  Â  --text:#0f172a;
Â  Â  Â  --muted:#6b7280;
Â  Â  Â  --accent:#10b981;
Â  Â  Â  --accentSoft:#d1fae5;

Â  Â  Â  --bubbleUser:#10b981;
Â  Â  Â  --bubbleAI:#eef2f7;

Â  Â  Â  --shadow: 0 10px 30px rgba(2,6,23,.08);
Â  Â  Â  --shadow2: 0 8px 20px rgba(2,6,23,.10);

Â  Â  Â  --btn:#111827;
Â  Â  Â  --btnText:#fff;

Â  Â  Â  --chip:#11182710;
Â  Â  Â  --chipText:#111827;

Â  Â  Â  --inputBg:#ffffff;
Â  Â  Â  --inputBorder:#d1d5db;
Â  Â  }

Â  Â  body.dark{
Â  Â  Â  --bg:#020617;
Â  Â  Â  --panel:#020617;
Â  Â  Â  --panel2:#0b1220;
Â  Â  Â  --border:#1f2937;
Â  Â  Â  --text:#e5e7eb;
Â  Â  Â  --muted:#9ca3af;
Â  Â  Â  --accent:#22c55e;
Â  Â  Â  --accentSoft:#052e16;

Â  Â  Â  --bubbleUser:#16a34a;
Â  Â  Â  --bubbleAI:#0b1220;

Â  Â  Â  --shadow: 0 10px 30px rgba(0,0,0,.45);
Â  Â  Â  --shadow2: 0 8px 20px rgba(0,0,0,.35);

Â  Â  Â  --btn:#111827;
Â  Â  Â  --btnText:#fff;

Â  Â  Â  --chip:#ffffff12;
Â  Â  Â  --chipText:#e5e7eb;

Â  Â  Â  --inputBg:#020617;
Â  Â  Â  --inputBorder:#334155;
Â  Â  }

Â  Â  *{box-sizing:border-box}
Â  Â  body{
Â  Â  Â  margin:0;
Â  Â  Â  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
Â  Â  Â  background:
Â  Â  Â  Â  radial-gradient(900px 500px at 15% 0%, rgba(16,185,129,.16), transparent 60%),
Â  Â  Â  Â  radial-gradient(900px 500px at 85% 10%, rgba(56,189,248,.12), transparent 60%),
Â  Â  Â  Â  var(--bg);
Â  Â  Â  color:var(--text);
Â  Â  Â  height:100vh;
Â  Â  Â  overflow:hidden;
Â  Â  Â  display:flex;
Â  Â  }

Â  Â  /* Layout */
Â  Â  .app{width:100%; display:flex; height:100vh; max-width:1400px; margin:0 auto;}

Â  Â  /* Sidebar */
Â  Â  .sidebar{
Â  Â  Â  width:290px;
Â  Â  Â  background:linear-gradient(to bottom, var(--panel), var(--panel2));
Â  Â  Â  border-right:1px solid var(--border);
Â  Â  Â  padding:14px;
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:12px;
Â  Â  }

Â  Â  .brand{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:10px;
Â  Â  Â  padding:6px 4px;
Â  Â  }
Â  Â  .brand-left{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:10px;
Â  Â  Â  min-width:0;
Â  Â  }
Â  Â  .logo{
Â  Â  Â  width:28px;height:28px;border-radius:999px;
Â  Â  Â  background: radial-gradient(circle at 30% 30%, #a7f3d0, #22c55e);
Â  Â  Â  box-shadow: 0 0 18px rgba(34,197,94,.55);
Â  Â  }
Â  Â  .brand-title{
Â  Â  Â  font-weight:700;
Â  Â  Â  font-size:16px;
Â  Â  Â  white-space:nowrap;
Â  Â  Â  overflow:hidden;
Â  Â  Â  text-overflow:ellipsis;
Â  Â  }
Â  Â  .pill{
Â  Â  Â  font-size:11px;
Â  Â  Â  padding:4px 8px;
Â  Â  Â  border-radius:999px;
Â  Â  Â  background:var(--accentSoft);
Â  Â  Â  color:var(--accent);
Â  Â  Â  border:1px solid rgba(34,197,94,.25);
Â  Â  Â  white-space:nowrap;
Â  Â  }

Â  Â  .btn{
Â  Â  Â  border:none;
Â  Â  Â  background:var(--accent);
Â  Â  Â  color:#fff;
Â  Â  Â  font-weight:600;
Â  Â  Â  border-radius:10px;
Â  Â  Â  padding:10px 12px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  box-shadow: 0 10px 18px rgba(16,185,129,.25);
Â  Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  Â  gap:8px;
Â  Â  Â  font-size:14px;
Â  Â  }
Â  Â  .btn:hover{filter:brightness(1.03)}
Â  Â  .btn:active{transform:translateY(1px)}

Â  Â  .sidebar-tools{
Â  Â  Â  display:flex; gap:8px; align-items:center;
Â  Â  }
Â  Â  .chip-btn{
Â  Â  Â  flex:1;
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  background:var(--panel);
Â  Â  Â  color:var(--text);
Â  Â  Â  border-radius:999px;
Â  Â  Â  padding:8px 10px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  font-size:12px;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  gap:6px;
Â  Â  }
Â  Â  .chip-btn:hover{background:rgba(148,163,184,.12)}

Â  Â  .chatlist{
Â  Â  Â  flex:1;
Â  Â  Â  overflow:auto;
Â  Â  Â  padding:4px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  background: rgba(255,255,255,.25);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  }
Â  Â  body.dark .chatlist{background: rgba(2,6,23,.35)}
Â  Â  .chat-item{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:8px;
Â  Â  Â  padding:9px 10px;
Â  Â  Â  border-radius:10px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  user-select:none;
Â  Â  Â  margin-bottom:6px;
Â  Â  Â  border:1px solid transparent;
Â  Â  }
Â  Â  .chat-item:hover{background:rgba(148,163,184,.16)}
Â  Â  .chat-item.active{
Â  Â  Â  background:var(--accentSoft);
Â  Â  Â  border:1px solid rgba(34,197,94,.25);
Â  Â  }
Â  Â  .chat-title{
Â  Â  Â  flex:1;
Â  Â  Â  min-width:0;
Â  Â  Â  white-space:nowrap;
Â  Â  Â  overflow:hidden;
Â  Â  Â  text-overflow:ellipsis;
Â  Â  Â  font-size:13px;
Â  Â  Â  color:var(--text);
Â  Â  }
Â  Â  .chat-meta{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:6px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  font-size:11px;
Â  Â  Â  white-space:nowrap;
Â  Â  }

Â  Â  .menu-wrap{ position:relative; }
Â  Â  .menu-btn{
Â  Â  Â  border:none;
Â  Â  Â  background:transparent;
Â  Â  Â  color:var(--muted);
Â  Â  Â  cursor:pointer;
Â  Â  Â  font-size:18px;
Â  Â  Â  padding:0 6px;
Â  Â  Â  line-height:1;
Â  Â  Â  border-radius:8px;
Â  Â  }
Â  Â  .menu-btn:hover{background:rgba(148,163,184,.16); color:var(--text)}
Â  Â  .menu{
Â  Â  Â  position:absolute;
Â  Â  Â  right:0;
Â  Â  Â  top:28px;
Â  Â  Â  width:170px;
Â  Â  Â  background:var(--panel);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:12px;
Â  Â  Â  box-shadow: var(--shadow2);
Â  Â  Â  overflow:hidden;
Â  Â  Â  display:none;
Â  Â  Â  z-index:50;
Â  Â  }
Â  Â  .menu.open{display:block;}
Â  Â  .menu-item{
Â  Â  Â  padding:10px 12px;
Â  Â  Â  font-size:13px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  color:var(--text);
Â  Â  }
Â  Â  .menu-item:hover{background:rgba(148,163,184,.14)}
Â  Â  .menu-item.danger{color:#ef4444}
Â  Â  .menu-item.danger:hover{background:rgba(239,68,68,.10)}

Â  Â  .footer-hint{
Â  Â  Â  font-size:11px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  padding:0 4px;
Â  Â  Â  line-height:1.4;
Â  Â  }

Â  Â  /* Main */
Â  Â  .main{flex:1; display:flex; flex-direction:column; height:100%;}
Â  Â  .topbar{
Â  Â  Â  height:56px;
Â  Â  Â  border-bottom:1px solid var(--border);
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  padding:0 18px;
Â  Â  Â  background: rgba(255,255,255,.45);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  }
Â  Â  body.dark .topbar{background: rgba(2,6,23,.55)}
Â  Â  .topbar-left{
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:2px;
Â  Â  Â  min-width:0;
Â  Â  }
Â  Â  .topbar-title{
Â  Â  Â  font-weight:700;
Â  Â  Â  font-size:14px;
Â  Â  Â  white-space:nowrap;
Â  Â  Â  overflow:hidden;
Â  Â  Â  text-overflow:ellipsis;
Â  Â  }
Â  Â  .topbar-sub{
Â  Â  Â  font-size:11px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  white-space:nowrap;
Â  Â  Â  overflow:hidden;
Â  Â  Â  text-overflow:ellipsis;
Â  Â  }

Â  Â  .messages{
Â  Â  Â  flex:1;
Â  Â  Â  overflow:auto;
Â  Â  Â  padding:18px 20px 10px;
Â  Â  Â  position:relative;
Â  Â  }

Â  Â  /* Empty state */
Â  Â  .empty{
Â  Â  Â  position:absolute;
Â  Â  Â  inset:0;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  padding:20px;
Â  Â  }
Â  Â  .empty-card{
Â  Â  Â  width:min(560px, 100%);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:16px;
Â  Â  Â  background: rgba(255,255,255,.55);
Â  Â  Â  backdrop-filter: blur(12px);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  padding:18px 16px;
Â  Â  Â  text-align:center;
Â  Â  }
Â  Â  body.dark .empty-card{background: rgba(2,6,23,.65)}
Â  Â  .empty-title{
Â  Â  Â  font-weight:800;
Â  Â  Â  font-size:18px;
Â  Â  Â  margin:6px 0 6px;
Â  Â  }
Â  Â  .empty-sub{
Â  Â  Â  color:var(--muted);
Â  Â  Â  font-size:13px;
Â  Â  Â  margin:0 0 12px;
Â  Â  }
Â  Â  .empty-actions{
Â  Â  Â  display:flex;
Â  Â  Â  flex-wrap:wrap;
Â  Â  Â  gap:8px;
Â  Â  Â  justify-content:center;
Â  Â  }
Â  Â  .quick{
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  background:var(--panel);
Â  Â  Â  color:var(--text);
Â  Â  Â  padding:8px 10px;
Â  Â  Â  border-radius:999px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  font-size:12px;
Â  Â  }
Â  Â  .quick:hover{background:rgba(148,163,184,.14)}

Â  Â  /* Bubbles */
Â  Â  .row{display:flex; margin-bottom:10px;}
Â  Â  .row.user{justify-content:flex-end;}
Â  Â  .bubble{
Â  Â  Â  max-width:72%;
Â  Â  Â  padding:11px 13px;
Â  Â  Â  border-radius:16px;
Â  Â  Â  box-shadow: 0 6px 16px rgba(2,6,23,.08);
Â  Â  Â  white-space:pre-wrap;
Â  Â  Â  word-wrap:break-word;
Â  Â  Â  font-size:14px;
Â  Â  Â  line-height:1.45;
Â  Â  }
Â  Â  body.dark .bubble{box-shadow: 0 6px 18px rgba(0,0,0,.35)}
Â  Â  .bubble.user{
Â  Â  Â  background:var(--bubbleUser);
Â  Â  Â  color:#ecfdf5;
Â  Â  Â  border-bottom-right-radius:6px;
Â  Â  }
Â  Â  .bubble.ai{
Â  Â  Â  background:var(--bubbleAI);
Â  Â  Â  color:var(--text);
Â  Â  Â  border:1px solid rgba(148,163,184,.18);
Â  Â  Â  border-bottom-left-radius:6px;
Â  Â  }

Â  Â  .attachments{
Â  Â  Â  margin-top:8px;
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:6px;
Â  Â  }
Â  Â  .att{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:8px;
Â  Â  Â  padding:8px 10px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  background: rgba(148,163,184,.12);
Â  Â  Â  font-size:12px;
Â  Â  Â  color:var(--text);
Â  Â  }
Â  Â  .att small{color:var(--muted)}
Â  Â  .att img{
Â  Â  Â  max-width:260px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  border:1px solid rgba(148,163,184,.25);
Â  Â  Â  display:block;
Â  Â  }

Â  Â  /* Typing */
Â  Â  .typing{
Â  Â  Â  display:inline-flex;
Â  Â  Â  gap:4px;
Â  Â  Â  align-items:center;
Â  Â  }
Â  Â  .dot{
Â  Â  Â  width:6px; height:6px;
Â  Â  Â  background:#9ca3af;
Â  Â  Â  border-radius:999px;
Â  Â  Â  animation: blink 1.2s infinite ease-in-out;
Â  Â  Â  opacity:.45;
Â  Â  }
Â  Â  .dot:nth-child(2){animation-delay:.2s}
Â  Â  .dot:nth-child(3){animation-delay:.4s}
Â  Â  @keyframes blink{
Â  Â  Â  0%,80%,100%{transform:translateY(0);opacity:.35}
Â  Â  Â  40%{transform:translateY(-2px);opacity:1}
Â  Â  }

Â  Â  /* Composer */
Â  Â  .composer{
Â  Â  Â  border-top:1px solid var(--border);
Â  Â  Â  padding:12px 14px;
Â  Â  Â  background: rgba(255,255,255,.55);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  }
Â  Â  body.dark .composer{background: rgba(2,6,23,.65)}
Â  Â  .composer-inner{
Â  Â  Â  display:flex;
Â  Â  Â  gap:10px;
Â  Â  Â  align-items:flex-end;
Â  Â  Â  border:1px solid var(--inputBorder);
Â  Â  Â  background:var(--inputBg);
Â  Â  Â  border-radius:14px;
Â  Â  Â  padding:10px 10px;
Â  Â  Â  box-shadow: var(--shadow2);
Â  Â  }
Â  Â  body.dark .composer-inner{border-color:var(--inputBorder)}
Â  Â  .icon-btn{
Â  Â  Â  border:none;
Â  Â  Â  background:transparent;
Â  Â  Â  cursor:pointer;
Â  Â  Â  padding:8px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  font-size:18px;
Â  Â  Â  line-height:1;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  }
Â  Â  .icon-btn:hover{background:rgba(148,163,184,.14); color:var(--text)}
Â  Â  .text{
Â  Â  Â  flex:1;
Â  Â  Â  min-height:22px;
Â  Â  Â  max-height:140px;
Â  Â  Â  resize:none;
Â  Â  Â  border:none;
Â  Â  Â  outline:none;
Â  Â  Â  font-size:14px;
Â  Â  Â  line-height:1.45;
Â  Â  Â  background:transparent;
Â  Â  Â  color:var(--text);
Â  Â  Â  padding:8px 4px;
Â  Â  }
Â  Â  .send{
Â  Â  Â  border:none;
Â  Â  Â  background:var(--accent);
Â  Â  Â  color:#fff;
Â  Â  Â  font-weight:700;
Â  Â  Â  padding:10px 14px;
Â  Â  Â  border-radius:12px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:8px;
Â  Â  Â  box-shadow: 0 10px 18px rgba(16,185,129,.25);
Â  Â  }
Â  Â  .send:disabled{opacity:.55; cursor:not-allowed}
Â  Â  .composer-hint{
Â  Â  Â  font-size:11px;
Â  Â  Â  color:var(--muted);
Â  Â  Â  padding:8px 2px 0;
Â  Â  Â  display:flex;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:8px;
Â  Â  }

Â  Â  @media (max-width: 900px){
Â  Â  Â  .sidebar{display:none;}
Â  Â  }
Â  </style>
</head>

<body class="dark">
Â  <div class="app">
Â  Â  Â  Â  <aside class="sidebar">
Â  Â  Â  <div class="brand">
Â  Â  Â  Â  <div class="brand-left">
Â  Â  Â  Â  Â  <div class="logo"></div>
Â  Â  Â  Â  Â  <div class="brand-title">MorAI</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="pill">Gemini</div>
Â  Â  Â  </div>

Â  Â  Â  <button class="btn" id="newChatBtn">+ Yeni sohbet</button>

Â  Â  Â  <div class="sidebar-tools">
Â  Â  Â  Â  <button class="chip-btn" id="themeBtn">ğŸŒ™ / â˜€ï¸ Tema</button>
Â  Â  Â  Â  <button class="chip-btn" id="clearAllBtn" title="TÃ¼m sohbetleri temizle">ğŸ§¹ Temizle</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="chatlist" id="chatList"></div>

Â  Â  Â  <div class="footer-hint">
Â  Â  Â  Â  â€¢ Sohbetlerin tarayÄ±cÄ±da kaydolur (localStorage).<br/>
Â  Â  Â  Â  â€¢ Sohbet satÄ±rÄ±ndaki <b>â‹¯</b> menÃ¼sÃ¼nden silebilirsin.
Â  Â  Â  </div>
Â  Â  </aside>

Â  Â  Â  Â  <main class="main">
Â  Â  Â  <header class="topbar">
Â  Â  Â  Â  <div class="topbar-left">
Â  Â  Â  Â  Â  <div class="topbar-title" id="chatTitle">Yeni sohbet</div>
Â  Â  Â  Â  Â  <div class="topbar-sub">Enter: gÃ¶nder â€¢ Shift+Enter: satÄ±r</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="topbar-sub" id="statusText">HazÄ±r</div>
Â  Â  Â  </header>

Â  Â  Â  <section class="messages" id="messages">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty" id="emptyState" style="display:none;">
Â  Â  Â  Â  Â  <div class="empty-card">
Â  Â  Â  Â  Â  Â  <div style="font-size:22px;">ğŸ‘‹</div>
Â  Â  Â  Â  Â  Â  <div class="empty-title">Nereden baÅŸlayalÄ±m?</div>
Â  Â  Â  Â  Â  Â  <p class="empty-sub">Bir mesaj yaz, fotoÄŸraf veya dosya ekle.</p>
Â  Â  Â  Â  Â  Â  <div class="empty-actions">
Â  Â  Â  Â  Â  Â  Â  <button class="quick" data-q="KÄ±sa bir plan Ã§Ä±kar: BugÃ¼n ne yapmalÄ±yÄ±m?">BugÃ¼n plan</button>
Â  Â  Â  Â  Â  Â  Â  <button class="quick" data-q="Bir paragraf motivasyon cÃ¼mlesi yaz">Motivasyon</button>
Â  Â  Â  Â  Â  Â  Â  <button class="quick" data-q="Bana 5 maddede Ã¼retkenlik Ã¶nerisi ver">Ãœretkenlik</button>
Â  Â  Â  Â  Â  Â  Â  <button class="quick" data-q="Bu hafta iÃ§in bir okuma listesi Ã¶ner">Okuma listesi</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  <section class="composer">
Â  Â  Â  Â  <div class="composer-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="icon-btn" id="attachBtn" title="Dosya / fotoÄŸraf ekle">ğŸ“</button>
Â  Â  Â  Â  Â  <input id="fileInput" type="file" multiple accept="image/*" hidden /> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="input" class="text" placeholder="Mesaj yaz..."></textarea>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="send" id="sendBtn">
Â  Â  Â  Â  Â  Â  GÃ¶nder <span style="opacity:.9">â¤</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="composer-hint">
Â  Â  Â  Â  Â  <span>Sadece gÃ¶rseller Base64 olarak API'ye gÃ¶nderilir.</span>
Â  Â  Â  Â  Â  <span id="charInfo">0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>
Â  Â  </main>
Â  </div>

<script>
Â  // =========================
Â  // Config
Â  // =========================
Â  const BACKEND_URL = "/api/chat"; // Sunucunuzun chat endpoint'i
Â  const MEMORY_DEPTH = 12; // Sohbet hafÄ±zasÄ±nda tutulacak son mesaj sayÄ±sÄ± (kullanÄ±cÄ± + AI)

Â  // =========================
Â  // Storage Keys
Â  // =========================
Â  const LS_CHATS = "morai_chats_v2";
Â  const LS_THEME = "morai_theme_v2";

Â  // =========================
Â  // State
Â  // =========================
Â  let chats = safeParse(localStorage.getItem(LS_CHATS), []);
Â  let currentId = chats[0]?.id || null;
Â  let sending = false;

Â  // =========================
Â  // Helpers (YardÄ±mcÄ± Fonksiyonlar)
Â  // =========================
Â  function safeParse(str, fallback){
Â  Â  try { return str ? JSON.parse(str) : fallback; } catch { return fallback; }
Â  }
Â  function save(){
Â  Â  localStorage.setItem(LS_CHATS, JSON.stringify(chats));
Â  }
Â  function uid(){
Â  Â  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
Â  }
Â  function byId(id){
Â  Â  return chats.find(c => c.id === id) || null;
Â  }
Â  function setStatus(text){
Â  Â  document.getElementById("statusText").textContent = text;
Â  }
Â  function closeAllMenus(){
Â  Â  document.querySelectorAll(".menu.open").forEach(m => m.classList.remove("open"));
Â  }
Â  document.addEventListener("click", (e)=>{
Â  Â  if(!e.target.closest(".menu-wrap")) closeAllMenus();
Â  });
Â  function getMimeType(dataUrl){
Â  Â  if (!dataUrl || typeof dataUrl !== 'string') return null;
Â  Â  const match = dataUrl.match(/^data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+);base64,/);
Â  Â  return match ? match[1] : null;
Â  }
Â  function fileToDataUrl(file){
Â  Â  return new Promise((resolve, reject)=>{
Â  Â  Â  const r = new FileReader();
Â  Â  Â  r.onload = ()=> resolve(r.result);
Â  Â  Â  r.onerror = reject;
Â  Â  Â  r.readAsDataURL(file);
Â  Â  });
Â  }
Â  function formatBytes(bytes){
Â  Â  if(bytes === 0) return "0 B";
Â  Â  const k = 1024;
Â  Â  const sizes = ["B","KB","MB","GB","TB"];
Â  Â  const i = Math.floor(Math.log(bytes)/Math.log(k));
Â  Â  return parseFloat((bytes/Math.pow(k,i)).toFixed(1)) + " " + sizes[i];
Â  }
Â  function escapeHtml(s){
Â  Â  return String(s).replace(/[&<>"']/g, (c)=>({
Â  Â  Â  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
Â  Â  }[c]));
Â  }

Â  // =========================
Â  // Theme (Tema YÃ¶netimi)
Â  // =========================
Â  function applyThemeFromStorage(){
Â  Â  const t = localStorage.getItem(LS_THEME);
Â  Â  if(t === "light") document.body.classList.remove("dark");
Â  Â  else document.body.classList.add("dark");
Â  }
Â  function toggleTheme(){
Â  Â  document.body.classList.toggle("dark");
Â  Â  localStorage.setItem(LS_THEME, document.body.classList.contains("dark") ? "dark" : "light");
Â  }

Â  // =========================
Â  // Chat CRUD (Sohbet YÃ¶netimi)
Â  // =========================
Â  function ensureChat(){
Â  Â  if(!chats.length){
Â  Â  Â  const id = uid();
Â  Â  Â  chats = [{ id, title:"Yeni sohbet", createdAt: Date.now(), messages: [] }];
Â  Â  Â  currentId = id;
Â  Â  Â  save();
Â  Â  }
Â  Â  if(!currentId) currentId = chats[0].id;
Â  }

Â  function newChat(){
Â  Â  const id = uid();
Â  Â  chats.unshift({ id, title:"Yeni sohbet", createdAt: Date.now(), messages: [] });
Â  Â  currentId = id;
Â  Â  save();
Â  Â  renderAll();
Â  }

Â  function deleteChat(id){
Â  Â  const c = byId(id);
Â  Â  if(!c) return;
Â  Â  const ok = confirm(`"${c.title || "Bu sohbet"}" silinsin mi?`);
Â  Â  if(!ok) return;
Â  Â  chats = chats.filter(x => x.id !== id);
Â  Â  if(!chats.length){
Â  Â  Â  currentId = null;
Â  Â  Â  ensureChat();
Â  Â  } else {
Â  Â  Â  currentId = chats[0].id;
Â  Â  }
Â  Â  save();
Â  Â  renderAll();
Â  }

Â  function clearAll(){
Â  Â  const ok = confirm("TÃ¼m sohbetler silinsin mi?");
Â  Â  if(!ok) return;
Â  Â  chats = [];
Â  Â  currentId = null;
Â  Â  save();
Â  Â  ensureChat();
Â  Â  renderAll();
Â  }

Â  // =========================
Â  // Rendering (ArayÃ¼z Ã‡izimi)
Â  // =========================
Â  function renderHeader(){
Â  Â  const c = byId(currentId);
Â  Â  document.getElementById("chatTitle").textContent = c?.title || "Yeni sohbet";
Â  }

Â  function renderChatList(){
Â  Â  const list = document.getElementById("chatList");
Â  Â  list.innerHTML = "";

Â  Â  chats.forEach(chat => {
Â  Â  Â  const item = document.createElement("div");
Â  Â  Â  item.className = "chat-item" + (chat.id === currentId ? " active" : "");
Â  Â  Â  item.onclick = () => { currentId = chat.id; renderAll(); };

Â  Â  Â  const title = document.createElement("div");
Â  Â  Â  title.className = "chat-title";
Â  Â  Â  title.textContent = chat.title || "Yeni sohbet";

Â  Â  Â  const meta = document.createElement("div");
Â  Â  Â  meta.className = "chat-meta";
Â  Â  Â  const count = chat.messages?.filter(m => m.role !== "system").length || 0; // Sadece user/ai mesajlarÄ±nÄ± say
Â  Â  Â  meta.textContent = count ? `${count}` : "";

Â  Â  Â  const menuWrap = document.createElement("div");
Â  Â  Â  menuWrap.className = "menu-wrap";

Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  btn.className = "menu-btn";
Â  Â  Â  btn.textContent = "â‹¯";
Â  Â  Â  btn.title = "MenÃ¼";
Â  Â  Â  btn.onclick = (e) => {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  closeAllMenus();
Â  Â  Â  Â  menu.classList.toggle("open");
Â  Â  Â  };

Â  Â  Â  const menu = document.createElement("div");
Â  Â  Â  menu.className = "menu";

Â  Â  Â  const del = document.createElement("div");
Â  Â  Â  del.className = "menu-item danger";
Â  Â  Â  del.innerHTML = `<span>Sil</span><span>ğŸ—‘ï¸</span>`;
Â  Â  Â  del.onclick = (e) => { e.stopPropagation(); menu.classList.remove("open"); deleteChat(chat.id); };

Â  Â  Â  menu.appendChild(del);
Â  Â  Â  menuWrap.appendChild(btn);
Â  Â  Â  menuWrap.appendChild(menu);

Â  Â  Â  item.appendChild(title);
Â  Â  Â  item.appendChild(meta);
Â  Â  Â  item.appendChild(menuWrap);
Â  Â  Â  list.appendChild(item);
Â  Â  });
Â  }

Â  function renderMessages(){
Â  Â  const wrap = document.getElementById("messages");
Â  Â  const empty = document.getElementById("emptyState");

Â  Â  // Ã¶nce eski mesajlarÄ± temizle (emptyState kalacak)
Â  Â  [...wrap.querySelectorAll(".row")].forEach(n => n.remove());

Â  Â  const chat = byId(currentId);
Â  Â  // Sadece user/ai/typing mesajlarÄ±nÄ± gÃ¶steriyoruz. Sistem notlarÄ±nÄ± (eklendi gibi) gizle.
Â  Â  const msgs = (chat?.messages || []).filter(m => m.role !== "system"); 

Â  Â  // Empty state
Â  Â  if(msgs.length === 0){
Â  Â  Â  empty.style.display = "flex";
Â  Â  } else {
Â  Â  Â  empty.style.display = "none";
Â  Â  }

Â  Â  msgs.forEach(m => {
Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  row.className = "row " + (m.role === "user" ? "user" : "ai");

Â  Â  Â  const bubble = document.createElement("div");
Â  Â  Â  bubble.className = "bubble " + (m.role === "user" ? "user" : "ai");

Â  Â  Â  // content
Â  Â  Â  if(m.type === "typing"){
Â  Â  Â  Â  bubble.innerHTML = `<span class="typing">
Â  Â  Â  Â  Â  <span class="dot"></span><span class="dot"></span><span class="dot"></span>
Â  Â  Â  Â  </span>`;
Â  Â  Â  } else {
Â  Â  Â  Â  bubble.textContent = m.content || "";
Â  Â  Â  }

Â  Â  Â  // attachments preview
Â  Â  Â  if(m.attachments && m.attachments.length){
Â  Â  Â  Â  const attBox = document.createElement("div");
Â  Â  Â  Â  attBox.className = "attachments";

Â  Â  Â  Â  m.attachments.forEach(a=>{
Â  Â  Â  Â  Â  const att = document.createElement("div");
Â  Â  Â  Â  Â  att.className = "att";
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Base64 verisi varsa (Sadece gÃ¶rsellerde olur)
Â  Â  Â  Â  Â  if(a.kind === "image" && a.dataUrl){
Â  Â  Â  Â  Â  Â  att.innerHTML = `<div>ğŸ–¼ï¸ <b>${escapeHtml(a.name || "GÃ¶rsel")}</b> <small>${a.sizeText || ""}</small></div>`;
Â  Â  Â  Â  Â  Â  const img = document.createElement("img");
Â  Â  Â  Â  Â  Â  img.src = a.dataUrl;
Â  Â  Â  Â  Â  Â  img.alt = a.name || "image";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  attBox.appendChild(att);
Â  Â  Â  Â  Â  Â  attBox.appendChild(img);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // DiÄŸer dosyalar
Â  Â  Â  Â  Â  Â  att.innerHTML = `ğŸ“ <b>${escapeHtml(a.name)}</b> <small>${a.sizeText || ""}</small>`;
Â  Â  Â  Â  Â  Â  attBox.appendChild(att);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  bubble.appendChild(attBox);
Â  Â  Â  }

Â  Â  Â  row.appendChild(bubble);
Â  Â  Â  wrap.appendChild(row);
Â  Â  });

Â  Â  wrap.scrollTop = wrap.scrollHeight;
Â  }

Â  function renderAll(){
Â  Â  renderChatList();
Â  Â  renderHeader();
Â  Â  renderMessages();
Â  }

Â  // =========================
Â  // Composer (Mesaj Yazma AlanÄ±)
Â  // =========================
Â  const inputEl = document.getElementById("input");
Â  const sendBtn = document.getElementById("sendBtn");
Â  const charInfo = document.getElementById("charInfo");

Â  inputEl.addEventListener("input", ()=>{
Â  Â  charInfo.textContent = String(inputEl.value.length);
Â  });

Â  inputEl.addEventListener("keydown", (e)=>{
Â  Â  if(e.key === "Enter" && !e.shiftKey){
Â  Â  Â  e.preventDefault();
Â  Â  Â  sendMessage();
Â  Â  }
Â  });

Â  // Quick prompts
Â  document.querySelectorAll(".quick").forEach(btn=>{
Â  Â  btn.addEventListener("click", ()=>{
Â  Â  Â  const q = btn.getAttribute("data-q") || "";
Â  Â  Â  inputEl.value = q;
Â  Â  Â  charInfo.textContent = String(q.length);
Â  Â  Â  inputEl.focus();
Â  Â  });
Â  });

Â  // Attachments (stored for next send)
Â  let pendingAttachments = [];

Â  document.getElementById("attachBtn").addEventListener("click", ()=>{
Â  Â  document.getElementById("fileInput").click();
Â  });

Â  document.getElementById("fileInput").addEventListener("change", async (e)=>{
Â  Â  const files = Array.from(e.target.files || []);
Â  Â  if(!files.length) return;

Â  Â  const newAttachments = [];
Â  Â  for(const f of files){
Â  Â  Â  const sizeText = formatBytes(f.size);
Â  Â  Â  if(f.type && f.type.startsWith("image/")){
Â  Â  Â  Â  // GÃ¶rsel ise Base64'e Ã§evir
Â  Â  Â  Â  const dataUrl = await fileToDataUrl(f);
Â  Â  Â  Â  newAttachments.push({ kind:"image", name:f.name, sizeText, dataUrl, mimeType: f.type });
Â  Â  Â  } else {
Â  Â  Â  Â  // DiÄŸer dosyalar (sadece meta verisi, API'ye gÃ¶nderilmeyecek)
Â  Â  Â  Â  newAttachments.push({ kind:"file", name:f.name, sizeText });
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Sadece Base64 iÃ§eriÄŸi olanlarÄ± (gÃ¶rselleri) pending listesine ekle
Â  Â  pendingAttachments.push(...newAttachments.filter(a => a.kind === "image"));

Â  Â  // KullanÄ±cÄ±ya eklenenleri gÃ¶steren sistem notu
Â  Â  const chat = byId(currentId);
Â  Â  chat.messages.push({
Â  Â  Â  role:"system", // Bu rol, renderMessages'ta gÃ¶sterilmeyecek.
Â  Â  Â  content:`Ek eklendi (${newAttachments.length}): ` + newAttachments.map(x=>x.name).join(", "),
Â  Â  Â  attachments: newAttachments
Â  Â  });
Â  Â  save();
Â  Â  renderAll();

Â  Â  // reset input
Â  Â  e.target.value = "";
Â  });

Â  document.getElementById("sendBtn").addEventListener("click", sendMessage);

Â  // =========================
Â  // Sending (GÃ¶nderme Ä°ÅŸlemi)
Â  // =========================
Â  async function sendMessage(){
Â  Â  if(sending) return;

Â  Â  const text = inputEl.value.trim();
Â  Â  
Â  Â  // EÄŸer ne metin ne de bekleyen Base64 gÃ¶rseli varsa gÃ¶nderme
Â  Â  if(!text && pendingAttachments.length === 0) return;

Â  Â  ensureChat();
Â  Â  const chat = byId(currentId);
Â  Â  
Â  Â  // BaÅŸlÄ±k atama kÄ±smÄ±
Â  Â  if(chat.title === "Yeni sohbet" && (text || pendingAttachments.length)){
Â  Â  Â  chat.title = (text || "Ekli bir sohbet").slice(0, 32); 
Â  Â  }

Â  Â  // 1. KullanÄ±cÄ± MesajÄ±nÄ± (UI iÃ§in) OluÅŸturma ve Ekleme
Â  Â  const userAttachments = pendingAttachments.length ? pendingAttachments : undefined;
Â  Â  const userMsg = {
Â  Â  Â  role:"user",
Â  Â  Â  content: text || "(Ekli mesaj)",
Â  Â  Â  attachments: userAttachments
Â  Â  };
Â  Â  chat.messages.push(userMsg);

Â  Â  // Typing (UI iÃ§in)
Â  Â  const typing = { role:"ai", type:"typing", content:"" };
Â  Â  chat.messages.push(typing);

Â  Â  // UI gÃ¼ncellemeleri
Â  Â  sending = true;
Â  Â  sendBtn.disabled = true;
Â  Â  setStatus("GÃ¶nderiliyorâ€¦");
Â  Â  save();
Â  Â  renderAll();

Â  Â  inputEl.value = "";
Â  Â  charInfo.textContent = "0";

Â  Â  // 2. API Payload'unu HazÄ±rlama (HafÄ±za + Yeni Mesaj)
Â  Â  
Â  Â  // a) AnlÄ±k MesajÄ±n 'parts' Dizisi (Mevcut metin + Base64 Ekler)
Â  Â  const newParts = [];

Â  Â  // GÃ¶rsel Base64 verilerini ekle (InlineData)
Â  Â  pendingAttachments.forEach(att => {
Â  Â  Â  if(att.kind === "image" && att.dataUrl){
Â  Â  Â  Â  const base64Data = att.dataUrl.split(",")[1];
Â  Â  Â  Â  const mimeType = getMimeType(att.dataUrl);
Â  Â  Â  Â  
Â  Â  Â  Â  if(base64Data && mimeType){
Â  Â  Â  Â  Â  newParts.push({
Â  Â  Â  Â  Â  Â  inlineData: {
Â  Â  Â  Â  Â  Â  Â  data: base64Data,
Â  Â  Â  Â  Â  Â  Â  mimeType: mimeType
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  // Mesaj metnini parts'a ekle
Â  Â  if (text) {
Â  Â  Â  newParts.push({ text: text });
Â  Â  }
Â  Â  
Â  Â  // b) Sohbet HafÄ±zasÄ±nÄ± OluÅŸturma (History)
Â  Â  const historyPayload = [];

Â  Â  // Son X mesajÄ± al (gÃ¼ncel mesaj hariÃ§) ve filtrele
Â  Â  const msgsForHistory = chat.messages
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .slice(0, chat.messages.length - 1) // Son mesajÄ± (yeni eklenen userMsg) hariÃ§ tut
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(m => m.role === "user" || m.role === "ai") // Sadece user/ai mesajlarÄ±nÄ± al
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .slice(-MEMORY_DEPTH); // Son X (12) mesajÄ± al

Â  Â  msgsForHistory.forEach(m => {
Â  Â  Â  const partsForAPI = [];
Â  Â  Â  
Â  Â  Â  // 1. Metin iÃ§eriÄŸi
Â  Â  Â  if(m.content && m.content.trim()){
Â  Â  Â  Â  partsForAPI.push({ text: m.content });
Â  Â  Â  }

Â  Â  Â  // 2. Ekler (Ã–nceki mesajlardaki gÃ¶rsellerin Base64 verisi)
Â  Â  Â  m.attachments?.forEach(att => {
Â  Â  Â  Â  if(att.kind === "image" && att.dataUrl){
Â  Â  Â  Â  Â  const base64Data = att.dataUrl.split(",")[1];
Â  Â  Â  Â  Â  const mimeType = getMimeType(att.dataUrl);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  if(base64Data && mimeType){
Â  Â  Â  Â  Â  Â  partsForAPI.push({
Â  Â  Â  Â  Â  Â  Â  inlineData: {
Â  Â  Â  Â  Â  Â  Â  Â  data: base64Data,
Â  Â  Â  Â  Â  Â  Â  Â  mimeType: mimeType
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // EÄŸer mesajÄ±n API'ye gÃ¶nderilecek bir parÃ§asÄ± varsa ekle
Â  Â  Â  if (partsForAPI.length > 0) {
Â  Â  Â  Â  historyPayload.push({
Â  Â  Â  Â  Â  role: m.role,
Â  Â  Â  Â  Â  parts: partsForAPI
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  // c) Temizle
Â  Â  pendingAttachments = [];
Â  Â  
Â  Â  // 3. Backend'e isteÄŸi gÃ¶nder
Â  Â  try{
Â  Â  Â  Â  const res = await fetch(BACKEND_URL, {
Â  Â  Â  Â  Â  Â  method:"POST",
Â  Â  Â  Â  Â  Â  headers:{ "Content-Type":"application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ parts: newParts, history: historyPayload }) 
Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await res.json().catch(()=> ({}));

Â  Â  Â  Â  // typing gÃ¶stergesini kaldÄ±r
Â  Â  Â  Â  const idx = chat.messages.indexOf(typing);
Â  Â  Â  Â  if(idx >= 0) chat.messages.splice(idx, 1);

Â  Â  Â  Â  // YanÄ±tÄ± kaydet
Â  Â  Â  Â  const reply = (data && typeof data.reply === "string" && data.reply.trim()) 
Â  Â  Â  Â  Â  Â  Â  Â  Â  ? data.reply 
Â  Â  Â  Â  Â  Â  Â  Â  Â  : (data.error ? data.detail : "Valla reis bu sefer boÅŸ dÃ¼ÅŸtÃ¼ ğŸ˜…");

Â  Â  Â  Â  chat.messages.push({ role:"ai", content: reply });

Â  Â  Â  Â  setStatus("HazÄ±r");
Â  Â  Â  Â  save();
Â  Â  Â  Â  renderAll();
Â  Â  } catch(err){
Â  Â  Â  Â  // Hata olursa typing'i kaldÄ±r ve hata mesajÄ±nÄ± gÃ¶ster
Â  Â  Â  Â  const idx = chat.messages.indexOf(typing);
Â  Â  Â  Â  if(idx >= 0) chat.messages.splice(idx, 1);
Â  Â  Â  Â  chat.messages.push({ role:"ai", content: "Sunucu baÄŸlantÄ± hatasÄ±: " + String(err?.message || err) });

Â  Â  Â  Â  setStatus("Hata");
Â  Â  Â  Â  save();
Â  Â  Â  Â  renderAll();
Â  Â  } finally{
Â  Â  Â  Â  sending = false;
Â  Â  Â  Â  sendBtn.disabled = false;
Â  Â  }
Â  }

Â  // =========================
Â  // Wire buttons (Buton BaÄŸlantÄ±larÄ±)
Â  // =========================
Â  document.getElementById("newChatBtn").addEventListener("click", newChat);
Â  document.getElementById("themeBtn").addEventListener("click", toggleTheme);
Â  document.getElementById("clearAllBtn").addEventListener("click", clearAll);

Â  // =========================
Â  // Init (BaÅŸlatma)
Â  // =========================
Â  applyThemeFromStorage();
Â  ensureChat();
Â  renderAll();
Â  setStatus("HazÄ±r");
</script>
</body>
</html>
