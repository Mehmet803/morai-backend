<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MorAI</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb;height:100vh;display:flex}
.app{display:flex;width:100%}
.sidebar{width:260px;background:#020617;border-right:1px solid #1f2937;padding:12px}
.main{flex:1;display:flex;flex-direction:column}
.top{height:50px;border-bottom:1px solid #1f2937;padding:12px;font-weight:bold}
.messages{flex:1;overflow:auto;padding:12px}
.row{margin-bottom:10px}
.user{color:#22c55e}
.ai{color:#e5e7eb}
.composer{border-top:1px solid #1f2937;padding:10px;display:flex;gap:8px}
textarea{flex:1;resize:none;padding:8px;background:#020617;color:#e5e7eb;border:1px solid #334155}
button{padding:8px 14px;background:#22c55e;border:none;color:#052e16;font-weight:bold;cursor:pointer}
</style>
</head>

<body>
<div class="app">

  <div class="sidebar">
    <button id="newChatBtn">+ Yeni Sohbet</button>
  </div>

  <div class="main">
    <div class="top" id="chatTitle">Yeni sohbet</div>
    <div class="messages" id="messages"></div>

    <div class="composer">
      <textarea id="input" rows="2" placeholder="Mesaj yaz..."></textarea>
      <button id="sendBtn">GÃ¶nder</button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = "/api/chat";
const LS_KEY = "morai_memory_v1";

/* ================= STATE ================= */
let chats = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let current = 0;
let sending = false;

if(chats.length === 0){
  chats.push({ title:"Yeni sohbet", messages: [] });
}

/* ================= RENDER ================= */
function render(){
  const box = document.getElementById("messages");
  const title = document.getElementById("chatTitle");
  box.innerHTML = "";
  title.textContent = chats[current].title;

  chats[current].messages.forEach(m=>{
    const div = document.createElement("div");
    div.className = "row " + m.role;
    div.textContent = m.content;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

/* ================= SEND ================= */
async function sendMessage(){
  if(sending) return;

  const input = document.getElementById("input");
  const text = input.value.trim();
  if(!text) return;

  const chat = chats[current];

  if(chat.title === "Yeni sohbet"){
    chat.title = text.slice(0,32);
  }

  chat.messages.push({ role:"user", content:text });
  input.value = "";
  render();

  // ðŸ”¥ HAFIZA (son 10 mesaj)
  const history = chat.messages
    .filter(m => m.role === "user" || m.role === "ai")
    .slice(-10);

  sending = true;

  try{
    const res = await fetch(BACKEND_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ messages: history })
    });

    const data = await res.json();
    chat.messages.push({
      role:"ai",
      content: data.reply || "Cevap gelmedi"
    });
  }catch(e){
    chat.messages.push({
      role:"ai",
      content:"Sunucu hatasÄ±"
    });
  }

  sending = false;
  localStorage.setItem(LS_KEY, JSON.stringify(chats));
  render();
}

/* ================= EVENTS ================= */
document.getElementById("sendBtn").addEventListener("click", sendMessage);

document.getElementById("input").addEventListener("keydown", e=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

document.getElementById("newChatBtn").addEventListener("click", ()=>{
  chats.push({ title:"Yeni sohbet", messages: [] });
  current = chats.length - 1;
  localStorage.setItem(LS_KEY, JSON.stringify(chats));
  render();
});

/* ================= START ================= */
render();
</script>
</body>
</html>
